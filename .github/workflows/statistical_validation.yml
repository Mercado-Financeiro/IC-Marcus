name: ğŸ”¬ Statistical Validation & Bias Detection

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'core/scripts/**'
      - 'core/data/**'
      - 'tests/statistical/**'
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  statistical-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11]
        test-suite: ['bias-detection', 'temporal-validation', 'feature-quality', 'model-robustness']

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install scipy statsmodels pingouin arch

    - name: ğŸ”¬ Run Statistical Tests - ${{ matrix.test-suite }}
      run: |
        python -m pytest tests/statistical/test_${{ matrix.test-suite }}.py -v --tb=short
      env:
        PYTHONPATH: ${{ github.workspace }}

    - name: ğŸ“Š Generate Statistical Report
      if: matrix.test-suite == 'bias-detection'
      run: |
        python tests/statistical/generate_bias_report.py

    - name: ğŸ“ˆ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: statistical-results-${{ matrix.test-suite }}
        path: |
          tests/statistical/reports/
          tests/statistical/plots/

    - name: ğŸ’¬ Comment PR with Results
      if: github.event_name == 'pull_request' && matrix.test-suite == 'bias-detection'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('tests/statistical/reports/bias_summary.md')) {
            const report = fs.readFileSync('tests/statistical/reports/bias_summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”¬ Statistical Validation Results\n\n${report}`
            });
          }

  data-quality-check:
    runs-on: ubuntu-latest
    needs: statistical-tests

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install pandas numpy scipy great-expectations

    - name: ğŸ” Data Quality Validation
      run: |
        python tests/statistical/data_quality_suite.py

    - name: ğŸ“Š Generate Quality Report
      run: |
        python tests/statistical/quality_report_generator.py

    - name: ğŸš¨ Fail on Critical Issues
      run: |
        python tests/statistical/check_critical_failures.py

  model-bias-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install ML Dependencies
      run: |
        pip install -r requirements.txt
        pip install fairlearn aif360 shap lime

    - name: ğŸ¯ Model Fairness Audit
      run: |
        python tests/statistical/model_fairness_audit.py

    - name: ğŸ“ˆ Bias Metrics Dashboard
      run: |
        python tests/statistical/bias_dashboard_generator.py

    - name: ğŸ“¤ Deploy Bias Report
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./tests/statistical/bias_dashboard
        destination_dir: bias-reports
